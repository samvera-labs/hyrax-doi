# IMPLEMENTATION PROCESS DETAILS
# Summary
A step by step guide to accompany [README](https://github.com/samvera-labs/hyrax-doi) implementation, usage, and configuration with the [DataCite RA](https://datacite.org/) and [Hyrax v2.9.0](https://github.com/samvera/hyrax/tree/v2.9.0) application.


## Step 1

Add this line to `app_name/Gemfile`:

```
gem 'hyrax-doi'
```

And then execute the [bundle](https://bundler.io/) command in your terminal:
```
bundle
```
If / when you run into conflicting gem dependencies and you are not able to run `bundle` try upgrading the conflicting versions with [conservative flag](https://bundler.io/v2.2/man/bundle-update.1.html) like so:
```
bundle update faraday --conservative 
```
Make sure you have successfully bundled and resolved any dependency issues before moving onto the generator commands.


## Step 2
Run the install generator command in your terminal.

Use the `--datacite` flag if working with DataCite DOIs:
```
rails g hyrax:doi:install --datacite
```
If not using DataCite DOIs:
```
rails g hyrax:doi:install
```

## Step 3

Run the generator to add DOI support to a given work type.

Add the `--datacite` flag if creating DataCite DOIs:
```
rails g hyrax:doi:add_to_work_type MyWorkType --datacite
```
If not using DataCite DOIs:

```
rails g hyrax:doi:add_to_work_type MyWorkType
```

* This will add 2 properties to your worktype's model: `doi` and `doi_status_when_public`  At this point you could load your app and see the new DOI fields on the edit/new form for work types but there is currently no connection to the DOI Registration Agent (RA).
* It will also add the DOI behavior to the worktype's presenter and you'll see the value of that in Step 6.
* Worth noting that if you are working with DataCite DOIs and your work types do not have `publisher` metadata you'll need to add those to the form for the autofill button to be able to drop the value of publisher from DataCite into that field.

## Step 4
Set up connection to DOI Registration Agent.  
* Get credentials from RA of choice - in this example we will use [DataCite](https://datacite.org/) and their test site [Fabrica](https://doi.test.datacite.org/).
* Obtain testing credentials from your RA administrator or request direct from support@datacite.org.
* Obtain production credentials from your RA administrator.
* Add the credentials to your application's `.env` or where ever your credentials are stored.  Note that if that place is not in your `.env` file then be sure to update the location added by the generate command earlier in `config/initializers/hyrax-doi.rb` by default it looks like this if you generated with the `--datacite` flag.
```
Hyrax::DOI::DataCiteRegistrar.prefix = ENV['DATACITE_PREFIX']
Hyrax::DOI::DataCiteRegistrar.username = ENV['DATACITE_USERNAME']
Hyrax::DOI::DataCiteRegistrar.password = ENV['DATACITE_PASSWORD']
```
* Should you be using something like a Helm Chart to manage your production and development environment variables then you will want to store your production credentials in the `app_name/chart/production-values.yaml.enc` and your test credentials from Fabrica in the `app_name/chart/dev-values.yaml.enc`

## Step 5
Connect your application's metadata to the metadata provided by your DOI RA.  See this wiki page on [Crosswalking Metadata with Bolognese](https://github.com/K8Sewell/hyrax-doi/wiki/Metadata-Crosswalking-with-Bolognese) for additional details.

## Step 6
Make the DOI visible on the work's show page.  Add a line to your `views/hyrax/base/_attribute_rows.html.erb` to make the field visible.
```
<%= presenter.attribute_to_html(:doi, render_as: :external_link, html_dl: true) if respond_to?(:render_doi?) && render_doi?(presenter) %>
```

## Step 7
Make sure that in `config/initializers/hyrax-doi.rb` your `default_url_options[:host]` must be set for the gem to work.  

```
## Set a default host for urls generated by the DOI registrars (if necessary)
Rails.application.routes.default_url_options[:host] = 'localhost:3000'
```

## Step 8
Set your environment.  By default the generator command that created your `config/initializers/hyrax-doi.rb` file will set this to `:test`
```
Hyrax::DOI::DataCiteRegistrar.mode = :test 
```
To enable production mode replace the value with `:production`
```
Hyrax::DOI::DataCiteRegistrar.mode = :production
```
What will this change?  There are different urls that DataCite uses for production and testing.  This configuration can be found in the [Hyrax DOI gem's service for DataCite](https://github.com/samvera-labs/hyrax-doi/blob/main/app/services/hyrax/doi/datacite_client.rb).

## Step 9
Add DOI actor to Hyrax initialize process.

In `app_name/config/initializers/hyrax.rb` add this line before the end of config block.

```
Hyrax.config do |config|
# 
#
    Hyrax::CurationConcern.actor_factory.insert_after(Hyrax::Actors::InitializeWorkflowActor, Hyrax::Actors::DOIActor)
end

```


## Step 10
Restart your application and test out the autofill and draft DOI features.


# Optional Configuration
## Override Form View
### Step 1
Configure a helper to add doi to the new/edit form tabs

Create the file `app_name/app/helpers/hyrax/doi/work_form_helper.rb` with the sample content below.
```
# frozen_string_literal: true

module Hyrax
  module DOI
    module WorkFormHelper
      def form_tabs_for(form:)
        if form.model_class.ancestors.include? Hyrax::DOI::DOIBehavior
          # TODO: Add check for feature flipper?
          super.append("doi")
        else
          super
        end
      end
    end
  end
end
```
### Step 2
Override the Hyrax DOI gem's partials.

Create the following 2 files: `app_name/app/views/records/edit_forms/_doi.html.erb` and `app_name/app/views/records/edit_forms/_doi_status_when_public.html.erb`

Fill both files with the contents below.
```
<% nil %>
```


# Note on Testing

## DataCite Testing

In some cases the DataCite DOI RA credentials are stored in encrypted helm charts to carry these values to staging servers.  To run DOI specs locally you will also need to replace the `placeholder` values in your local `.env` file.  If there is a test stage to your deployment process you'll need to make sure these credentials are available to the CI you're using as well.
